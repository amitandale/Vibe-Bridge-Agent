{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://vibe.local/schema/contextpack.v1.schema.json",
  "title": "ContextPack",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "project",
    "pr",
    "mode",
    "order",
    "budgets",
    "sections",
    "must_include",
    "nice_to_have",
    "never_include",
    "provenance",
    "hash"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0.0"
    },
    "project": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "pr": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "branch",
        "commit_sha"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1
        },
        "branch": {
          "type": "string",
          "minLength": 1
        },
        "commit_sha": {
          "type": "string",
          "minLength": 7
        }
      }
    },
    "mode": {
      "type": "string",
      "enum": [
        "MVP",
        "PR",
        "FIX"
      ]
    },
    "order": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "templates",
          "spec_canvas",
          "diff_slices",
          "linked_tests",
          "contracts",
          "extras"
        ]
      }
    },
    "budgets": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "max_tokens",
        "max_files",
        "max_per_file_tokens",
        "section_caps"
      ],
      "properties": {
        "max_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "max_files": {
          "type": "integer",
          "minimum": 0
        },
        "max_per_file_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "section_caps": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "templates": {
              "type": "integer",
              "minimum": 0
            },
            "spec_canvas": {
              "type": "integer",
              "minimum": 0
            },
            "diff_slices": {
              "type": "integer",
              "minimum": 0
            },
            "linked_tests": {
              "type": "integer",
              "minimum": 0
            },
            "contracts": {
              "type": "integer",
              "minimum": 0
            },
            "extras": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      }
    },
    "sections": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "name",
          "items"
        ],
        "properties": {
          "name": {
            "type": "string",
            "enum": [
              "templates",
              "spec_canvas",
              "diff_slices",
              "linked_tests",
              "contracts",
              "extras"
            ]
          },
          "items": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "id"
              ],
              "properties": {
                "id": {
                  "type": "string",
                  "minLength": 1
                },
                "path": {
                  "type": "string"
                },
                "content": {
                  "type": "string"
                },
                "meta": {
                  "type": "object"
                },
                "sha256": {
                  "type": "string",
                  "pattern": "^[a-f0-9]{64}$"
                }
              }
            }
          }
        }
      }
    },
    "must_include": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "kind",
          "section",
          "loc",
          "sha256",
          "source"
        ],
        "properties": {
          "kind": {
            "type": "string",
            "enum": [
              "file",
              "symbol",
              "span"
            ]
          },
          "section": {
            "type": "string",
            "enum": [
              "templates",
              "spec_canvas",
              "diff_slices",
              "linked_tests",
              "contracts",
              "extras"
            ]
          },
          "loc": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "path",
              "start_line"
            ],
            "properties": {
              "path": {
                "type": "string"
              },
              "start_line": {
                "type": "integer",
                "minimum": 1
              },
              "end_line": {
                "type": "integer",
                "minimum": 1
              }
            }
          },
          "symbol": {
            "type": "string"
          },
          "sha256": {
            "type": "string",
            "pattern": "^[a-f0-9]{64}$"
          },
          "source": {
            "type": "string",
            "enum": [
              "planner",
              "mcp",
              "fs",
              "git",
              "openapi",
              "sql",
              "llamaindex"
            ]
          },
          "reason": {
            "type": "string"
          }
        }
      }
    },
    "nice_to_have": {
      "type": "array",
      "items": {
        "$ref": "#/properties/must_include/items"
      }
    },
    "never_include": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "provenance": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "source",
          "generator",
          "created_at"
        ],
        "properties": {
          "source": {
            "type": "string",
            "enum": [
              "planner",
              "mcp",
              "fs",
              "git",
              "openapi",
              "sql",
              "llamaindex"
            ]
          },
          "generator": {
            "type": "string"
          },
          "projectId": {
            "type": "string"
          },
          "commit_sha": {
            "type": "string",
            "minLength": 7
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$"
    }
  }
}